version: '3.8'

services:
  # Playwright Test Runner Service
  playwright-tests:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nicedice-playwright-tests
    environment:
      # Environment
      - NODE_ENV=${NODE_ENV:-local}
      
      # API Configuration
      - API_BASE_URL=${API_BASE_URL}
      - API_HOST=${API_HOST:-api}
      - API_PORT=${API_PORT:-3000}
      - API_PROTOCOL=${API_PROTOCOL:-http}
      - API_TIMEOUT=${API_TIMEOUT:-30000}
      
      # Frontend Configuration
      - FRONTEND_BASE_URL=${FRONTEND_BASE_URL}
      - FRONTEND_HOST=${FRONTEND_HOST:-frontend}
      - FRONTEND_PORT=${FRONTEND_PORT:-3001}
      - FRONTEND_PROTOCOL=${FRONTEND_PROTOCOL:-http}
      - FRONTEND_TIMEOUT=${FRONTEND_TIMEOUT:-30000}
      
      # Browser Settings
      - HEADLESS=${HEADLESS:-true}
      - SLOW_MO=${SLOW_MO:-0}
      - BROWSER=${BROWSER:-chromium}
      - PARALLEL_WORKERS=${PARALLEL_WORKERS:-2}
      
      # Test User
      - TEST_USER_EMAIL=${TEST_USER_EMAIL}
      - TEST_USER_PASSWORD=${TEST_USER_PASSWORD}
      
      # Reporting
      - REPORT_DIR=${REPORT_DIR:-./reports}
      - SCREENSHOT_ON_FAILURE=${SCREENSHOT_ON_FAILURE:-true}
      - VIDEO_ON_FAILURE=${VIDEO_ON_FAILURE:-true}
      
      # Feature Flags
      - ENABLE_API_LOGGING=${ENABLE_API_LOGGING:-true}
      - ENABLE_NETWORK_LOGS=${ENABLE_NETWORK_LOGS:-false}
    
    volumes:
      # Mount source code
      - .:/app
      - /app/node_modules
      
      # Mount reports output
      - ./reports:/app/reports
      - ./test-results:/app/test-results
    
    networks:
      - nicedice-network
    
    # Keep container running for interactive testing
    # Comment out for CI/CD or one-time runs
    stdin_open: true
    tty: true
    
    # Uncomment to run tests automatically on startup
    # command: npm run test
    
    depends_on:
      - api
      - frontend
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # Mock API Backend (optional - for local development)
  api:
    image: mockserver/mockserver:latest
    container_name: nicedice-api
    ports:
      - "${API_PORT:-3000}:1080"
    environment:
      - MOCKSERVER_LOG_LEVEL=INFO
      - MOCKSERVER_SERVER_PORT=1080
    networks:
      - nicedice-network
    profiles:
      - local-only
    # Uncomment to mount mock expectations
    # volumes:
    #   - ./mocks/api-expectations.json:/mockserver/expectations.json

  # Mock Frontend (optional - for local development)
  frontend:
    image: nginx:alpine
    container_name: nicedice-frontend
    ports:
      - "${FRONTEND_PORT:-3001}:80"
    networks:
      - nicedice-network
    profiles:
      - local-only
    # Uncomment to serve static frontend files
    # volumes:
    #   - ./mocks/frontend:/usr/share/nginx/html

networks:
  nicedice-network:
    driver: bridge

# Volumes for persistent data
volumes:
  test-reports:
  playwright-cache:
